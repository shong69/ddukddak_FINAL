<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ddukddak.board.model.mapper.MyHouseBoardMapper">
	
	<!-- 집들이 게시글 작성 -->
	<insert id="boardInsert" useGeneratedKeys="true" parameterType="Board">
		
		<selectKey order="BEFORE" resultType="_int" keyProperty="boardNo">
			SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
		</selectKey>
		
		INSERT INTO "COMMUNITY"
		VALUES ( #{boardNo},
				 #{boardTitle},
				 #{boardContent},
				 DEFAULT,
				 NULL,
				 DEFAULT,
				 DEFAULT,
				 #{memberNo},
				 1)
		
	</insert>
	
	<!-- 게시글 이미지 삽입 -->
	<insert id="insertUploadList" parameterType="list">
		
		INSERT INTO "UPLOAD_FILE"
		
		<foreach collection="list" item="img"
				open="(" close=")" separator=" UNION ">
		
		
				SELECT NEXT_UPLOAD_IMG_NO(),
					   #{img.uploadImgPath},
					   #{img.uploadImgOgName},
					   #{img.uploadImgRename},
					   #{img.uploadImgOrder},
					   3,
					   NULL,
					   #{img.boardNo},
					   NULL,
					   NULL
			  	FROM DUAL
				   
		</foreach>
		
	</insert>
	
	<!-- 집들이 게시판 조회 -->
	<select id="selectMyHouseList">
		SELECT BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, READ_COUNT,
		(SELECT UPLOAD_IMG_PATH || UPLOAD_IMG_RENAME FROM "UPLOAD_FILE" U WHERE C.BOARD_NO = U.BOARD_NO AND UPLOAD_IMG_ORDER = 0) THUMBNAIL,
		(SELECT COUNT(*) FROM "COMMENT" C WHERE C.BOARD_NO = C.BOARD_NO) COMMENT_COUNT,
		(SELECT COUNT(*) FROM "BOARD_LIKE" L WHERE L.BOARD_NO = C.BOARD_NO) LIKE_COUNT,
		<![CDATA[
		CASE
			WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24 / 60 
			THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60 * 60 ) || '초 전'
			WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24
			THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60 ) || '분 전'
			WHEN SYSDATE - BOARD_WRITE_DATE < 1
			THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 ) || '시간 전'
			ELSE TO_CHAR(BOARD_WRITE_DATE, 'YYYY-MM-DD')
		END BOARD_WRITE_DATE
		]]>
		FROM "COMMUNITY" C
		JOIN "MEMBER" USING (MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		ORDER BY BOARD_NO DESC
	</select>
	
	
	<!-- 게시글 수 조회 -->
	<select id="getListCount">
		SELECT COUNT(*) FROM "COMMUNITY"
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
	</select>
	
	
	<!-- 검색 조건에 맞는 게시글 수 조회 -->
	<select id="getSearchCount">
		SELECT COUNT(*) FROM COMMUNITY
		JOIN "MEMBER" USING (MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		AND (BOARD_TITLE LIKE '%' || #{query} || '%' OR MEMBER_NICKNAME LIKE '%' || #{query} || '%')	  
	</select>
	
	
	<!-- 검색 결과 목록 조회 -->
	<select id="selectSearchList">
		SELECT BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, READ_COUNT,
		(SELECT UPLOAD_IMG_PATH || UPLOAD_IMG_RENAME FROM "UPLOAD_FILE" U WHERE C.BOARD_NO = U.BOARD_NO AND UPLOAD_IMG_ORDER = 0) THUMBNAIL,
		(SELECT COUNT(*) FROM "COMMENT" C WHERE C.BOARD_NO = C.BOARD_NO) COMMENT_COUNT,
		(SELECT COUNT(*) FROM "BOARD_LIKE" L WHERE L.BOARD_NO = C.BOARD_NO) LIKE_COUNT,
		<![CDATA[
		CASE
			WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24 / 60 
			THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60 * 60 ) || '초 전'
			WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24
			THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60 ) || '분 전'
			WHEN SYSDATE - BOARD_WRITE_DATE < 1
			THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 ) || '시간 전'
			ELSE TO_CHAR(BOARD_WRITE_DATE, 'YYYY-MM-DD')
		END BOARD_WRITE_DATE
		]]>
		FROM "COMMUNITY" C
		JOIN "MEMBER" USING (MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		AND (BOARD_TITLE LIKE '%' || #{query} || '%' OR MEMBER_NICKNAME LIKE '%' || #{query} || '%')
	</select>
	
	
</mapper>


















