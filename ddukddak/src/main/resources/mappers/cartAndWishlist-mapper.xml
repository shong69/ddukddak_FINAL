<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ddukddak.myPage.model.mapper.CartAndWishListMapper">

	<!-- 장바구니 상품 목록 조회 장바구니아이디로 장아옵 테이블 조회 -> 조회한 옵션 아이디로 옵션테이블에서 옵션 이름 조회 + 상품 넘버로 이름, 이미지, 가격 조회  -->
	<!-- 결제 시  -->
	<select id="selectCartList">
		SELECT CART_ID, PRODUCT_NO, PRODUCT_NAME, PRODUCT_PRICE, PRODUCT_COUNT,
				UPLOAD_IMG_NO, UPLOAD_IMG_PATH, UPLOAD_IMG_OG_NAME, UPLOAD_IMG_RENAME
		FROM PRODUCT NATURAL JOIN CART NATURAL JOIN UPLOAD_FILE
		WHERE MEMBER_NO = #{memberNo}
		AND UPLOAD_IMG_ORDER = 0
		ORDER BY CART_ID
	</select>
	
	<!-- 장바구니 상품 옵션 아이디  -->
	<select id="selectCartListOptionNo">
		SELECT OPTION_NO
		FROM CARTITEM_OPTION
		WHERE CART_ID = #{cartId}
	</select>
	
	<!-- 장바구니 상품 옵션값  -->
	<select id="selectCartListOptionValue">
		SELECT OPTION_VALUE
		FROM CARTITEM_OPTION NATURAL JOIN "OPTION"
		WHERE CART_ID = #{cartId}
	</select>
	
	<!-- 장바구니 아이템 수량 수정 -->
	<update id="updateCount">
		UPDATE SET "CART"
		PRODUCT_COUNT = #{productCount}
		WHERE MEMBER_NO = #{memberNo}
		AND PRODUCT_NO = #{productNo}
	</update>
	
	<!-- 장바구니 아이템 삭제 -->
	<delete id="deleteProduct">
		DELETE FROM "CART"
		WHERE CART_ID = #{cartId}
	</delete>
	
	<!-- 장바구니 아이템 옵션 삭제 -->
	<delete id="deleteProductOption">
		DELETE FROM "CARTITEM_OPTION"
		WHERE CART_ID = #{cartId}
	</delete>
	
	<!-- 장바구니 상품 추가 -->
	<insert id="insertCartItem">
		INSERT INTO "CART"
		VALUES(SEQ_CART_ID.NEXTVAL,#{quantity},#{memberNo},#{productNo})
	</insert>
	
	
	<!-- 장바구니 상품 옵션 추가 -->
	<insert id="insertOption">
		INSERT INTO "CARTITEM_OPTION"
		VALUES(SEQ_CART_ID.CURRVAL,#{oneOption},SEQ_CARTITEM_OPTION_ID.NEXTVAL)
	</insert>
	
	<!-- 장바구니 상품 수량 변경 -->
	<update id="modifyCount">
		UPDATE "CART"
		SET PRODUCT_COUNT = #{quantity}
		WHERE CART_ID = #{cartId}
	</update>
	
	<!-- 위시리스트 추가 -->
	<insert id="addWish">
		INSERT INTO WISHLIST (MEMBER_NO, PRODUCT_NO)
		SELECT #{memberNo}, #{productNo}
		FROM DUAL
		WHERE NOT EXISTS (
		    SELECT 1 
		    FROM WISHLIST 
		    WHERE MEMBER_NO = #{memberNo}
		      AND PRODUCT_NO = #{productNo}
		)
	</insert>
	
	<!-- 위시리스트 삭제 -->
	<delete id="delWish" parameterType="map">
	    DELETE FROM WISHLIST
	    WHERE MEMBER_NO = #{memberNo}
	    AND PRODUCT_NO = #{productNo}
	</delete>
	
	<!-- 위시리스트 목록개수 조회 -->
	<select id="selectWishListCount">
		SELECT COUNT(*)
		FROM "WISHLIST"
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 위시리스트 목록조회 -->
	<select id="selectWishList">
		SELECT p.PRODUCT_NO, PRODUCT_NAME, PRODUCT_PRICE, PRODUCT_CREATE_DATE, PRODUCT_UPDATE_DATE,
		PRODUCT_FL, CATEGORY_NO, BIG_CATEGORY_NO, PARTNER_NO, UPLOAD_IMG_NO, UPLOAD_IMG_PATH, UPLOAD_IMG_OG_NAME, UPLOAD_IMG_RENAME,
		UPLOAD_IMG_ORDER
		FROM PRODUCT p
		JOIN UPLOAD_FILE uf ON(p.PRODUCT_NO = uf.PRODUCT_NO)
		LEFT JOIN "WISHLIST" w ON(p.PRODUCT_NO = w.PRODUCT_NO)
		NATURAL JOIN CATEGORY c
		NATURAL JOIN BIG_CATEGORY b
		WHERE p.PRODUCT_NO = w.PRODUCT_NO
		AND w.MEMBER_NO = #{memberNo}
		AND UPLOAD_IMG_ORDER = 0
	</select>
	
	<!-- 주문 목록 조회 -->
	<select id="selectOrderList">
		SELECT O.ORDER_NO, ORDER_DATE, ORDER_STATUS, ORDER_DEL_FL, D.ORDER_ITEM_NO, ORDER_QUANTITY, ORDER_PRICE, D.PRODUCT_NO,P.PRODUCT_NAME, 
		L.DELIVERY_ADDRESS, MEMBER_NO,
		(SELECT UPLOAD_IMG_PATH||UPLOAD_IMG_RENAME FROM UPLOAD_FILE F WHERE F.PRODUCT_NO =D.PRODUCT_NO AND UPLOAD_IMG_ORDER=0) PRODUCT_IMG,
		(LISTAGG(OPTION_VALUE,',') WITHIN GROUP (ORDER BY T.OPTION_NO)) OPTION_VALUE 
		FROM ORDERS O
		LEFT JOIN ORDER_DETAIL D ON(O.ORDER_NO = D.ORDER_NO)
		LEFT JOIN PRODUCT P ON(D.PRODUCT_NO = P.PRODUCT_NO)
		LEFT JOIN DELIVERY L ON(O.DELIVERY_ID = L.DELIVERY_ID)
		LEFT JOIN ORDERDETAIL_OPTION O2 ON(O2.ORDER_ITEM_NO = D.ORDER_ITEM_NO)
		LEFT JOIN "OPTION" T ON(T.OPTION_NO=O2.OPTION_NO)
		WHERE MEMBER_NO = #{memberNo}
		GROUP BY 
		    O.ORDER_NO, O.ORDER_DATE, O.ORDER_STATUS, O.ORDER_DEL_FL, 
		    D.ORDER_ITEM_NO, D.ORDER_QUANTITY, D.ORDER_PRICE, D.PRODUCT_NO, 
		    P.PRODUCT_NAME, L.DELIVERY_ADDRESS, O.MEMBER_NO
		ORDER BY ORDER_DATE DESC

	</select>

</mapper>
