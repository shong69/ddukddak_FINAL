<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뚝딱뚝딱 : 마이페이지</title>
    <link rel="stylesheet" href="/css/myPage/myPage.css">
    <link rel="stylesheet" href="/css/common/fragments/myPageSidebar.css">
    <link rel="stylesheet" href="/css/common/fragments/header.css">
    <link rel="stylesheet" href="/css/common/fragments/footer.css">
    <link rel="stylesheet" href="/css/common/main.css">
    <link rel="stylesheet" href="/css/common/style.css">
    <link rel="stylesheet" href="/css/common/button.css">
    <link rel="icon" type="image/x-icon" href="/images/main/favicon.ico">
    <script src="https://kit.fontawesome.com/4b505ed7b7.js" crossorigin="anonymous"></script>

</head>
<body>
    <th:block th:replace="~{common/fragments/header}"></th:block>
    <main>

        <th:block th:replace="~{common/fragments/myPageProfileSection}"></th:block>

        <section class="myPage-row2">
            <th:block th:replace="~{common/fragments/myPageSideBar}"></th:block>

            <section class="myPage-main">
                <h2 class="category-name">장바구니</h2>
                <form action="" method="POST" name = "cartForm" enctype="multipart/form-data">
                    <table class="cartList">
                        <thead>
                            <th>전체(N개)</th>
                            <th><input name = "check" id="totalCheck" type="checkbox"></th>
                            <th>상품이미지</th>
                            <th>상품정보[옵션]</th>
                            <th>주문수량</th>
                            <th>주문금액</th>
                            <th>주문관리</th>
                        </thead>
                        <tbody>
                            <!--<th:block th:if="${skuList} != null">
                                    <th:block th:foreach 어쩌구>
                                        <tr>
    
                                        </tr>
                                    </th>
                                </th>
                            -->
    
                            <th:object th:if="${#lists.isEmpty(cartList)}">
                                <tr>
                                    <td>텅~</td>
                                </tr>
                            </th:object>
                            <th:object th:unless="${#lists.isEmpty(cartList)}">
                                <tr class="boxCount" th:each = "list, listStat : ${cartList}" th:object="${list}"> <!--상품으로 나눠서 나열-->
                                    <td class="countBox" th:text="${listStat.count}">1</td>
                                    <td><input name="check" type="checkbox"></td>
                                    <td><a><img th:src="|*{uploadImgPath}*{uploadImgRename}|" class="product-image"></a></td>
                                    <td>
                                        <h4 th:text="*{productName}"></h4>
                                        <h4 th:text="*{optionValue}" style="color: var(--gray2);"></h4>
                                    </td>
                                    <td>
                                        <div class="adjustCount">
                                            <button type="button" class="quantity-btn" onclick="changeQuantity(this, -1)">-</button>
                                            <input type="text" th:name="'quantity'+${listStat.count} "th:value="*{productCount}" class="quantity-input" readonly>
                                            <input type="hidden" th:value="*{cartId}" id="optionIdInput">
                                            <button type="button" class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                                        </div>
                                    </td>
                                    <td class="price-input" th:text="|*{productPrice}원|" th:value="*{productPrice}">상품가격</td>
                                    <td>
                                        <button th:data-cartId =*{cartId} type="button" class="myPageDelUpdateBtn">삭제</button>
                                    </td>
                                </tr>
                            </th:object>

                        </tbody>
                    </table>
    
                    <div class="infoArea">
                        <div class="totalCount">총 <span id="totalCount">N</span>건</div>
                        <div class="totalPrice">합계 <span id="totalPrice">100000</span> 원</div>
                    </div>
                    <div class="pointArea">총 예상 포인트 <span id="pointArea">100</span>원</div>
                    <div class="purchaseArea">
                        <button class="selectedPurchage">선택상품 구매</button>
                        <button class="wholePurchase">전체상품 구매</button>
                    </div>
                </form>
                
            </section>
        </section>

        <th:block th:replace="~{common/fragments/footer}"></th:block>
        <script th:inline="javascript">
            function changeQuantity(button, change) {
                const input = button.parentElement.querySelector('.quantity-input');
                let currentQuantity = parseInt(input.value);
                currentQuantity += change;
                if (currentQuantity < 1) currentQuantity = 1;
                input.value = currentQuantity;

                const cartIdInput = input.parentElement.querySelector("#optionIdInput").value;

                const obj = {
                    "cartId" : cartIdInput,
                    "quantity" : currentQuantity
                }

                fetch("/myPage/modifyCount", {
                    method: "PUT",
                    headers : {"Content-Type" : "application/json"},
                    body : JSON.stringify(obj)
                })
                .then(resp => resp.json())
                .then(temp => {
                    console.log(temp);
                });

                calculateTotalCount();
                calculateTotalPrice();
                calculatePrice();
                calculatePoint();
                formatNumber();
            }
        </script>
        <script src="/js/myPage/shopping.js"></script>
</body>
</html>